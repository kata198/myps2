#!/bin/bash

echoerr() {
    echo "$@" >&2
}

usage() {
    echoerr "
Usage: configure (options)

Configure some options for myps2. Not required, only use to cutomize.

  Options:

    --help / -h / -?       -  Print this message
    --no-output-buffer     -  Instead of allocating a large buffer for stdout
                              use default line-by-line (slower, uses less mem)

    --output-buffer-size=N -  Set stdout output buffer size to N bytes.
                              Default: 5 * ARG_MAX + 1

    --num-username-buckets=N   -  uid -> username lookups are cached for performance.
                              This value specifies the number of buckets
                              used in these cache lookups, modulus uid.

                              Default is 10 which means one bucket for each
                              last digit of uid. This is a good value for most
                              systems. If you have a TON ( > 40 ) active users,
                              you may want to increase. If you have 1-2 active
                              users, you may want to decrease. Almost always
                              default is best value.

                              Must be > 0. Use 1 to have a single bucket
                              and disable splitting based on uid

    --threads-view-flat       On the *pst2* variants (which show threads), the default
                              is to display them \"tree-style\", that is indented from
                              the parent process.

                              If this option is specified, threads and processes
                              will be shown at the same level.

    --threads-view-full       On the *pst2* variants, show threads with same display
                              as a normal process. May still be tree or flat view.

Run with no arguments to restore default settings.
"

}

writef() {
    printf "$@" >> myps2_config.h
}

NO_OUTPUT_BUFFER=
OUTPUT_BUFFER_SIZE=
NUM_USERNAME_BUCKETS=
THREADS_VIEW_FLAT=

for arg in "$@";
do
    if [[ "$arg" = "--help" ]] || [[ "$arg" = "-h" ]] || [[ "$arg" = "-?" ]];
    then
        usage;
        exit 1;
    fi
    if ( echo "${arg}" | grep -q '^--no-output-buffer$' );
    then
        NO_OUTPUT_BUFFER="true"
    elif ( echo "${arg}" | grep -q '^--output-buffer-size=[0-9][0-9]*$' );
    then
        OUTPUT_BUFFER_SIZE=$(echo "${arg}" | sed 's|--output-buffer-size=||g')
    elif ( echo "${arg}" | grep -q '^--num-username-buckets=[0-9][0-9]*$' );
    then
        NUM_USERNAME_BUCKETS=$(echo "${arg}" | sed 's|--num-username-buckets=||g')
    elif ( echo "${arg}" | grep -q '^--threads-view-flat$' );
    then
        THREADS_VIEW_FLAT="true"
    elif ( echo "${arg}" | grep -q '^--threads-view-full$' );
    then
        THREADS_VIEW_FULL="true"
    else
        echoerr "Unknown/Invalid Argument: ${arg}"
        echoerr;
        usage;
        exit 1;
    fi
done

##### validation

if [[ -n "${NO_OUTPUT_BUFFER}" ]] && [ -n "${OUTPUT_BUFFER_SIZE}" -a "${OUTPUT_BUFFER_SIZE}" != "0" ];
then
    echoerr "--no-output-buffer and --output-buffer-size > 0 are mutually exclusive."
    exit 2;
fi

if [[ -n "${NUM_USERNAME_BUCKETS}" ]] && [[ ${NUM_USERNAME_BUCKETS} -le 0 ]];
then
    echoerr "--num-username-buckets must be > 0"
    exit 2
fi

##### generation

echo "Generating myps2_config.h..."

pushd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1

> myps2_config.h

writef "/* myps2_config.h Generated by %s using configure at %s */\n\n" "`whoami`" "`date`"
writef "#ifndef _MYPS2_CONFIG\n"
writef "#define _MYPS2_CONFIG\n"
writef "\n\n"

if [[ -n "${NO_OUTPUT_BUFFER}" ]];
then
    writef "#define NO_OUTPUT_BUFFER /* Disable large block buffering on stdout */\n\n"
fi

if [[ -n "${OUTPUT_BUFFER_SIZE}" ]];
then
    writef "#define OUTPUT_BUFFER_SIZE %d /* Set stdout block buffer to this size */\n\n" "${OUTPUT_BUFFER_SIZE}"
fi

if [[ -n "${NUM_USERNAME_BUCKETS}" ]];
then
    writef "#define LL_NUM_LISTS %d /* Use %d buckets for uid->username cache */\n\n" "${NUM_USERNAME_BUCKETS}"
fi

if [[ -n "${THREADS_VIEW_FLAT}" ]];
then
    writef "#define THREADS_VIEW_FLAT /* Show threads at same level as processes for *pst2* variants, i.e. no tree view. */\n\n"
fi

if [[ -n "${THREADS_VIEW_FULL}" ]];
then
    writef "#define THREADS_VIEW_FULL /* Show threads same as normal processes. */\n\n"
fi

writef "#endif\n"

cat myps2_config.h

popd >/dev/null 2>&1
